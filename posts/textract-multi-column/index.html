<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>How to Handle Multi-Column Text Sorting with Amazon Textract | Shannon's Blog üêü Tech | Life | Travel</title><meta name="author" content="Shannon Hung"><meta name="copyright" content="Shannon Hung"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="ÂâçË®Ä AWS Textract is an AWS tool used for extracting text from PDFs (or images). Ideally, your original document would have only one column, such as a book. However, things become more complex when deal">
<meta property="og:type" content="article">
<meta property="og:title" content="How to Handle Multi-Column Text Sorting with Amazon Textract">
<meta property="og:url" content="https://shannonhung.github.io/en/posts/textract-multi-column/">
<meta property="og:site_name" content="Shannon&#39;s Blog üêü Tech | Life | Travel">
<meta property="og:description" content="ÂâçË®Ä AWS Textract is an AWS tool used for extracting text from PDFs (or images). Ideally, your original document would have only one column, such as a book. However, things become more complex when deal">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://shannonhung.github.io/en/img/cover/ocr-scan.jpeg">
<meta property="article:published_time" content="2024-03-19T16:40:35.000Z">
<meta property="article:modified_time" content="2024-04-20T16:22:42.541Z">
<meta property="article:author" content="Shannon Hung">
<meta property="article:tag" content="aws">
<meta property="article:tag" content="textract">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://shannonhung.github.io/en/img/cover/ocr-scan.jpeg"><link rel="shortcut icon" href="/en/img/shannon-icon.png"><link rel="canonical" href="https://shannonhung.github.io/en/posts/textract-multi-column/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="IAmwAuWZP3fXPtoYru7VJBancFMT2BkhN15HC2iea1o"/><link rel="stylesheet" href="/en/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-XBNKVVH2P4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-XBNKVVH2P4');
</script><script>const GLOBAL_CONFIG = {
  root: '/en/',
  algolia: undefined,
  localSearch: {"path":"/en/search.xml","preload":false,"top_n_per_article":-1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: {"defaultEncoding":3,"translateDelay":0,"msgToTraditionalChinese":"ÁπÅ","msgToSimplifiedChinese":"Á∞°"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'How to Handle Multi-Column Text Sorting with Amazon Textract',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-21 00:22:42'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/en/css/style.css"><link rel="stylesheet" href="/en/css/background.css"><link rel="shortcut icon" href="#"/></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/en/img/loading-icon.gif" data-original="/en/img/dudu-me.png" onerror="onerror=null;src='/en/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/en/archives/"><div class="headline">Articles</div><div class="length-num">13</div></a><a href="/en/tags/"><div class="headline">Tags</div><div class="length-num">12</div></a><a href="/en/categories/"><div class="headline">Categories</div><div class="length-num">12</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> Home Page</span></a></div><div class="menus_item"><a class="site-page" href="/en/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categroies</span></a></div><div class="menus_item"><a class="site-page" href="/en/about/"><i class="fa-fw fas fa-heart"></i><span> About Me</span></a></div><div class="menus_item"><a class="site-page" href="/en/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> Find Posts</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/en/tags/"><i class="fa-fw fas fa-tags"></i><span> By Tags</span></a></li><li><a class="site-page child" href="/en/archives/"><i class="fa-fw fas fa-archive"></i><span> By Posts</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-language"></i><span> Language</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/en/"><i class="fa-fw fas fa-e"></i><span> English</span></a></li><li><a class="site-page child" href="https://shannonhung.github.io/"><i class="fa-fw fas fa-c"></i><span> ‰∏≠Êñá</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/en/img/cover/ocr-scan.jpeg')"><nav id="nav"><span id="blog-info"><a href="/en/" title="Shannon's Blog üêü Tech | Life | Travel"><span class="site-name">Shannon's Blog üêü Tech | Life | Travel</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> Home Page</span></a></div><div class="menus_item"><a class="site-page" href="/en/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categroies</span></a></div><div class="menus_item"><a class="site-page" href="/en/about/"><i class="fa-fw fas fa-heart"></i><span> About Me</span></a></div><div class="menus_item"><a class="site-page" href="/en/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> Find Posts</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/en/tags/"><i class="fa-fw fas fa-tags"></i><span> By Tags</span></a></li><li><a class="site-page child" href="/en/archives/"><i class="fa-fw fas fa-archive"></i><span> By Posts</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-language"></i><span> Language</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/en/"><i class="fa-fw fas fa-e"></i><span> English</span></a></li><li><a class="site-page child" href="https://shannonhung.github.io/"><i class="fa-fw fas fa-c"></i><span> ‰∏≠Êñá</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">How to Handle Multi-Column Text Sorting with Amazon Textract</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-03-19T16:40:35.000Z" title="Created 2024-03-20 00:40:35">2024-03-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-04-20T16:22:42.541Z" title="Updated 2024-04-21 00:22:42">2024-04-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/en/categories/Tech/">Tech</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/en/categories/Tech/OCR/">OCR</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">3.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>22mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="How to Handle Multi-Column Text Sorting with Amazon Textract"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/en/posts/textract-multi-column/#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ÂâçË®Ä">ÂâçË®Ä</h1>
<p>AWS Textract is an AWS tool used for extracting text from PDFs (or images). Ideally, your original document would have only one column, such as a book. However, things become more complex when dealing with multiple columns, such as newspaper articles. Therefore, this article aims to share how to use Amazon Textract to handle sorting of text from multi-column documents. This article is inspired by <a target="_blank" rel="noopener external nofollow noreferrer" href="https://medium.com/claranet-ch/aws-textract-how-to-detect-and-sort-text-from-a-multi-column-document-61e411f3e259">AWS Textract: how to detect and sort text from a multi-column document</a>, with some improvements made.</p>
<p>My source material is a newspaper article, with the layout as shown below:</p>
<p><img src="/en/img/loading-icon.gif" data-original="https://i.imgur.com/XOevNWt.png" alt=""></p>
<h1 id="Textract-Response-Format">Textract Response Format</h1>
<p>The Textract output is structured JSON formed by various BlockTypes. A ‚ÄúPage‚Äù BlockType consists of multiple ‚ÄúLine‚Äù blocks, and each ‚ÄúLine‚Äù block consists of multiple ‚ÄúWord‚Äù blocks. In these responses, you cannot see any structural information to simply sort multi-column text into a single column. However, what can be known is that Textract parses text from top to bottom and left to right. You can observe this parsing order from the numbered sections 27 to 48 in the image below, where even though they belong to different columns, Textract parses them sequentially from left to right and top to bottom.</p>
<p><img src="/en/img/loading-icon.gif" data-original="https://i.imgur.com/kWd9zkK.png" alt=""></p>
<h1 id="Solution">Solution</h1>
<p>The approach we adopt is to utilize the bounding box coordinates provided by Textract to draw boundaries around text blocks. By grouping nearby lines into a block, we can identify lines belonging to the same column. The final result will resemble the image below:</p>
<p><img src="/en/img/loading-icon.gif" data-original="https://i.imgur.com/szs2EFK.png" alt=""></p>
<p>From the above image, the following information can be inferred:</p>
<ul>
<li>The longest block is likely the title.</li>
<li>Other blocks can be sorted from top to bottom and left to right, allowing us to determine the reading order and understand the distribution of columns.</li>
</ul>
<h2 id="Step-1-Define-the-Class">Step 1: Define the Class</h2>
<p>From the official documentation on <a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.aws.amazon.com/zh_tw/textract/latest/dg/text-location.html">how to interpret target locations on the document</a>, it is described as follows:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;BoundingBox&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Width&quot;</span><span class="punctuation">:</span> <span class="number">0.007353090215474367</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Height&quot;</span><span class="punctuation">:</span> <span class="number">0.0288887619972229</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Left&quot;</span><span class="punctuation">:</span> <span class="number">0.08638829737901688</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Top&quot;</span><span class="punctuation">:</span> <span class="number">0.03477252274751663</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>From the official documentation<br>
<img src="/en/img/loading-icon.gif" data-original="https://i.imgur.com/VSHrpN5.png" alt=""><br>
<img src="/en/img/loading-icon.gif" data-original="https://i.imgur.com/wjdj6r2.png" alt=""></p>
</blockquote>
<p>After understanding the format, we can define a class to handle this data:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```python</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Page</span>: </span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Used to handle the content returned by Textract. Each Page may have one or more Lines.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        page (int): The number of this Page.</span></span><br><span class="line"><span class="string">        lines (Line): The Lines contained in this Page.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, page_number, lines</span>):</span><br><span class="line">        self.lines = lines</span><br><span class="line">        self.page = page_number</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> self.lines:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;line: <span class="subst">&#123;line.__str__()&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Page: <span class="subst">&#123;self.page&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Block</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Block: This is the Block we are dealing with. Each Block may have one or more Lines.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        page (int): The Page where this Block is located.</span></span><br><span class="line"><span class="string">        id (int): Simply records the index of this Block.</span></span><br><span class="line"><span class="string">        lines (Line): The Lines contained in this Block.</span></span><br><span class="line"><span class="string">        left (float): The x-coordinate of the top-left corner of the Block.</span></span><br><span class="line"><span class="string">        top (float): The y-coordinate of the top-left corner of the Block.</span></span><br><span class="line"><span class="string">        height (float): The height of the Block.</span></span><br><span class="line"><span class="string">        width (float): The width of the Block.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.lines = []</span><br><span class="line">        self.page = <span class="number">0</span></span><br><span class="line">        self.<span class="built_in">id</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.left = <span class="number">0</span> </span><br><span class="line">        self.top = <span class="number">0</span> </span><br><span class="line">        self.height = <span class="number">0</span> </span><br><span class="line">        self.width = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Block: page=<span class="subst">&#123;self.page&#125;</span>, id=<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, (x1,y1)=(<span class="subst">&#123;self.left&#125;</span>, <span class="subst">&#123;self.top&#125;</span>), (x2,y2)=(<span class="subst">&#123;self.left + self.width&#125;</span>,<span class="subst">&#123;self.top + self.height&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_line</span>(<span class="params">self, line</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; </span></span><br><span class="line"><span class="string">        Add a line to the block and recalculate the center of the block.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.lines.append(line)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Line</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Handles the smallest unit of text.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        page (int): The Page where this Line is located.</span></span><br><span class="line"><span class="string">        Id (int): The Line Id returned by Textract for easy lookup of the corresponding text in the original document.</span></span><br><span class="line"><span class="string">        text (str): The text of the Line.</span></span><br><span class="line"><span class="string">        top (float): The y-coordinate of the top-left corner of the Line.</span></span><br><span class="line"><span class="string">        left (float): The x-coordinate of the top-left corner of the Line.</span></span><br><span class="line"><span class="string">        width (float): The width of the Line.</span></span><br><span class="line"><span class="string">        height (float): The height of the Line.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, Id, page, text, top, left, width, height</span>):</span><br><span class="line">        self.top = top</span><br><span class="line">        self.left = left</span><br><span class="line">        self.width = width</span><br><span class="line">        self.height = height</span><br><span class="line">        self.page = page</span><br><span class="line">        self.Id = Id</span><br><span class="line">        self.text = text </span><br><span class="line">        self.center = self.get_center()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Line: \t page=<span class="subst">&#123;self.page&#125;</span>, Id=<span class="subst">&#123;self.Id&#125;</span>, Text=<span class="subst">&#123;self.text&#125;</span>, \n\t (x1,y1)=(<span class="subst">&#123;self.left&#125;</span>, top=<span class="subst">&#123;self.top&#125;</span>); width=<span class="subst">&#123;self.width&#125;</span>, height=<span class="subst">&#123;self.height&#125;</span> \n&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_center</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Get the center of the Line.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        x = self.left</span><br><span class="line">        y = self.top</span><br><span class="line">        x1 = self.left + self.width</span><br><span class="line">        y1 = self.top + self.height</span><br><span class="line">        x_center = (x + x1) / <span class="number">2</span></span><br><span class="line">        y_center = (y + y1) / <span class="number">2</span></span><br><span class="line">        <span class="keyword">return</span> [x_center, y_center]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Step-2-General-Function">Step 2: General Function</h2>
<p>Next, we need some general functions to handle the data. Here, we will need the following functions:</p>
<ul>
<li><code>read_json_file</code>: Read the JSON file returned by Textract.</li>
<li><code>two_point_distance</code>: Calculate the distance between two points. This will be used to calculate whether the center distance between Lines is too far.
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>=</mo><msqrt><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo>‚àí</mo><msub><mi>x</mi><mn>1</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>‚àí</mo><msub><mi>y</mi><mn>1</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">d = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.305em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.935em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">‚àí</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">‚àí</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.895em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width='400em' height='1.28em' viewBox='0 0 400000 1296' preserveAspectRatio='xMinYMin slice'><path d='M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.305em;"><span></span></span></span></span></span></span></span></span></li>
</ul>
</li>
<li><code>two_point_height</code>: Calculate the vertical distance between two Lines to determine if they are close enough.</li>
<li><code>pretty_similar</code>: Determine if the difference is within an acceptable range.</li>
<li><code>print_blocks</code>: Print information about Blocks.</li>
<li><code>get_lines_from_json</code>: Get information about Lines from the JSON returned by Textract.</li>
<li><code>find_block_corners</code>: Find the four corner coordinates of a Block to enclose all Lines.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> json </span><br><span class="line"><span class="keyword">from</span> pdf2image <span class="keyword">import</span> convert_from_bytes</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> matplotlib.patches <span class="keyword">import</span> Rectangle</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_json_file</span>(<span class="params">file_name</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_name, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        <span class="keyword">return</span> json.load(file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">two_point_distance</span>(<span class="params">x, y, x1, y1</span>):</span><br><span class="line">    distance = math.sqrt((x - x1) ** <span class="number">2</span> + (y - y1) ** <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> distance</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">two_point_hight</span>(<span class="params">y, y1</span>): </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">abs</span>(y-y1)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pretty_similar</span>(<span class="params">x, x1, tolerance</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">abs</span>(x - x1) &lt; tolerance</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_blocks</span>(<span class="params">blocks</span>):</span><br><span class="line">    <span class="keyword">for</span> block <span class="keyword">in</span> blocks:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;block.__str__()&#125;</span>&quot;</span>)</span><br><span class="line">        last_line = block.lines[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> block.lines:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Line: \t Page=<span class="subst">&#123;line.page&#125;</span>, Id=<span class="subst">&#123;line.Id&#125;</span>, left=<span class="subst">&#123;line.left&#125;</span>, top=<span class="subst">&#123;line.top&#125;</span>, width=<span class="subst">&#123;line.width&#125;</span>, height=<span class="subst">&#123;line.height&#125;</span>, center=<span class="subst">&#123;line.center&#125;</span> two_point_distance = <span class="subst">&#123;two_point_distance(last_line.center[<span class="number">0</span>], last_line.center[<span class="number">1</span>], line.center[<span class="number">0</span>], line.center[<span class="number">1</span>])&#125;</span> (x1,y1)=(<span class="subst">&#123;line.left&#125;</span>, <span class="subst">&#123;line.top&#125;</span>), (x2,y2)=(<span class="subst">&#123;line.left + line.width&#125;</span>,<span class="subst">&#123;line.top + line.height&#125;</span>)&quot;</span>)</span><br><span class="line">            last_line = line</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_lines_from_json</span>(<span class="params">file_path</span>):</span><br><span class="line">    json_response = read_json_file(file_path)</span><br><span class="line">    lines = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> json_response[<span class="string">&quot;Blocks&quot;</span>]:</span><br><span class="line">        <span class="keyword">if</span> item[<span class="string">&quot;BlockType&quot;</span>] == <span class="string">&quot;LINE&quot;</span>:</span><br><span class="line">            box = item[<span class="string">&quot;Geometry&quot;</span>][<span class="string">&quot;BoundingBox&quot;</span>]</span><br><span class="line">            lines.append(Line(item[<span class="string">&quot;Id&quot;</span>], item[<span class="string">&quot;Page&quot;</span>], item[<span class="string">&quot;Text&quot;</span>], box[<span class="string">&quot;Top&quot;</span>], box[<span class="string">&quot;Left&quot;</span>], box[<span class="string">&quot;Width&quot;</span>], box[<span class="string">&quot;Height&quot;</span>]))</span><br><span class="line">    <span class="keyword">return</span> lines</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_block_corners</span>(<span class="params">blocks</span>): </span><br><span class="line">    min_top = <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)</span><br><span class="line">    min_left = <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> index, block <span class="keyword">in</span> <span class="built_in">enumerate</span>(blocks):</span><br><span class="line">        min_top = <span class="built_in">min</span>(line.top <span class="keyword">for</span> line <span class="keyword">in</span> block.lines)</span><br><span class="line">        min_left = <span class="built_in">min</span>(line.left <span class="keyword">for</span> line <span class="keyword">in</span> block.lines)</span><br><span class="line">        max_bottom = <span class="built_in">max</span>(line.top + line.height <span class="keyword">for</span> line <span class="keyword">in</span> block.lines)</span><br><span class="line">        max_right = <span class="built_in">max</span>(line.left + line.width <span class="keyword">for</span> line <span class="keyword">in</span> block.lines)</span><br><span class="line"></span><br><span class="line">        block.height = max_bottom - min_top </span><br><span class="line">        block.width = max_right - min_left</span><br><span class="line">        block.top = min_top</span><br><span class="line">        block.left = min_left </span><br><span class="line">        block.<span class="built_in">id</span> = index</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> blocks</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_image_bbox</span>(<span class="params">pdf_file, blocks</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Use to show the image with bounding box</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(pdf_file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        images = convert_from_bytes(file.read())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> index, image <span class="keyword">in</span> <span class="built_in">enumerate</span>(images):</span><br><span class="line">        width, height =image.size  </span><br><span class="line">        page = index + <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Process Page Index: <span class="subst">&#123;page&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        plt.figure(figsize=(<span class="number">20</span>,<span class="number">16</span>))</span><br><span class="line">        plt.imshow(image)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># iterate over the blocks </span></span><br><span class="line">        <span class="keyword">for</span> i, block <span class="keyword">in</span> <span class="built_in">enumerate</span>(blocks):</span><br><span class="line">            <span class="keyword">if</span> (block.page == page):</span><br><span class="line">                rect = Rectangle((width * block.left, height * block.top), block.width * width, block.height * height, edgecolor=<span class="string">&#x27;r&#x27;</span>, facecolor=<span class="string">&#x27;none&#x27;</span>)</span><br><span class="line">                plt.text(width * block.left, height * block.top, block.<span class="built_in">id</span>, fontsize=<span class="number">12</span>, color=<span class="string">&#x27;red&#x27;</span>)</span><br><span class="line">                plt.gca().add_patch(rect)</span><br><span class="line">        plt.show()</span><br></pre></td></tr></table></figure>
<h2 id="Step-3-Define-Rule-of-Block">Step 3: Define Rule of Block</h2>
<p>ÁèæÂú®ÊàëÂÄëË¶ÅË®≠Ë®àÔºåÂú®‰ªÄÈ∫ºÊ®£ÁöÑÊ¢ù‰ª∂ÊªøË∂≥‰∏ãÂèØ‰ª•ÂΩ¢Êàê‰∏ÄÂÄãBlockÔºåÈÄôÈÇäÊàëÂÄëË®≠Ë®àÁöÑË¶èÂâáÂ¶Ç‰∏ãÔºö<br>
<img src="/en/img/loading-icon.gif" data-original="https://i.imgur.com/iyxK62j.png" alt=""></p>
<p>ÂÆöÁæ©Ë¶èÂâáÁöÑÁ®ãÂºèÁ¢ºÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">is_two_line_close</span>(<span class="params">block, target_line, cur_line</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Check if two lines are close enough, so we can merge them into a block</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    left_tolerance = <span class="number">0.02</span></span><br><span class="line">    width_tolerance =  <span class="number">0.01</span> <span class="comment"># [left_tolerance, (target_line.width - cur_line.width).abs / 2].max</span></span><br><span class="line">    distance_tolerance = <span class="number">0.04</span></span><br><span class="line">    height_tolerance = <span class="number">0.03</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_left_similar</span>(<span class="params">line1, line2, tolerance = left_tolerance</span>):</span><br><span class="line">        <span class="keyword">return</span> pretty_similar(line1.left, line2.left, tolerance)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_width_similar</span>(<span class="params">line1, line2, tolerance = width_tolerance</span>): </span><br><span class="line">        <span class="keyword">return</span>  pretty_similar(line1.width, line2.width, tolerance)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_height_similar</span>(<span class="params">line1, line2, tolerance = height_tolerance</span>):</span><br><span class="line">        <span class="keyword">return</span> two_point_hight(line1.top, line2.top) &lt; tolerance </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_on_same_page</span>(<span class="params">line1, line2</span>):</span><br><span class="line">        <span class="keyword">return</span> line1.page == line2.page</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_center_close</span>(<span class="params">line1, line2</span>):</span><br><span class="line">        <span class="keyword">return</span> two_point_distance(line1.center[<span class="number">0</span>], line1.center[<span class="number">1</span>], line2.center[<span class="number">0</span>], line2.center[<span class="number">1</span>]) &lt; distance_tolerance</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_same_paragraph</span>():</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Use to handle the same paragraph</span></span><br><span class="line"><span class="string">        If the starting point on the left is the same and the height is similar, they are in the same Block</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (is_left_similar(target_line, cur_line) <span class="keyword">and</span> </span><br><span class="line">            is_height_similar(block.lines[-<span class="number">1</span>], cur_line)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span> </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span> </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_text_center_context</span>():</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Use to handle the text in the center</span></span><br><span class="line"><span class="string">        If the center is close and the height is similar, they are in the same Block</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> (is_center_close(target_line, cur_line) <span class="keyword">and</span> is_height_similar(block.lines[-<span class="number">1</span>], cur_line))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># First check if they are on the same page, as a Block cannot span multiple pages</span></span><br><span class="line">    <span class="keyword">if</span> is_on_same_page(target_line, cur_line): </span><br><span class="line">        <span class="comment"># If in the same paragraph or the text is centered, select them into block</span></span><br><span class="line">        <span class="keyword">if</span> is_same_paragraph() <span class="keyword">or</span> is_text_center_context():</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<h2 id="Step-4-Iterate-Line-to-Form-Block">Step 4: Iterate Line to Form Block</h2>
<p>Then we can start iterating through all the Lines to find the Block.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge_lines_to_block</span>(<span class="params">lines</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Merge Lines into Blocks.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    ready_blocks = [] </span><br><span class="line"></span><br><span class="line">    <span class="comment"># As long as there are still lines, continue to form Blocks</span></span><br><span class="line">    <span class="keyword">while</span> lines: </span><br><span class="line">        block = Block()</span><br><span class="line">        target_line = lines[<span class="number">0</span>] <span class="comment"># Take the first Line as the first object to compare for forming a Block</span></span><br><span class="line">        block.add_line(lines[<span class="number">0</span>]) <span class="comment"># Add the target_line to the Block</span></span><br><span class="line">        block.page = target_line.page <span class="comment"># Set the Block&#x27;s Page</span></span><br><span class="line">        lines.pop(<span class="number">0</span>) <span class="comment"># Remove the target_line from lines</span></span><br><span class="line">        index = <span class="number">0</span>  <span class="comment"># Reset index to 0 because pop affects the index order</span></span><br><span class="line">        <span class="comment"># Recursively iterate through all Lines until there are no more lines to compare</span></span><br><span class="line">        <span class="keyword">while</span> index &lt; <span class="built_in">len</span>(lines):</span><br><span class="line">            cur_line = lines[index]</span><br><span class="line">            <span class="keyword">if</span> target_line.page == cur_line.page: </span><br><span class="line">                <span class="comment"># If the width is the same, the centers cannot be too far apart</span></span><br><span class="line">                <span class="keyword">if</span> is_two_line_close(block, target_line, cur_line):</span><br><span class="line">                    block.add_line(cur_line)</span><br><span class="line">                    lines.pop(index) <span class="comment"># After popping, cur_line needs to start from index 0</span></span><br><span class="line">                    index = <span class="number">0</span>  <span class="comment"># Reset index to 0</span></span><br><span class="line">                    <span class="keyword">continue</span>  <span class="comment"># Continue to the next iteration</span></span><br><span class="line">            index += <span class="number">1</span>  <span class="comment"># Check the next element</span></span><br><span class="line"></span><br><span class="line">        ready_blocks.append(block) <span class="comment"># Add the organized Block to the list</span></span><br><span class="line">    <span class="keyword">return</span> ready_blocks</span><br></pre></td></tr></table></figure>
<h2 id="Step-5-Execution">Step 5: Execution</h2>
<p>Finally, we can execute the code:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">json_path = <span class="string">&quot;./result/test.json&quot;</span> <span class="comment"># Path to the JSON file returned by Textract</span></span><br><span class="line">pdf_path = <span class="string">&quot;../../src/test.pdf&quot;</span></span><br><span class="line"></span><br><span class="line">lines = get_lines_from_json(json_path) <span class="comment"># Get information about Lines from the JSON returned by Textract</span></span><br><span class="line">blocks = merge_lines_to_block(lines) <span class="comment"># Merge Lines into Blocks </span></span><br><span class="line">blocks = find_block_corners(blocks) <span class="comment"># Find the four corner coordinates of a Block to enclose all Lines</span></span><br><span class="line">show_image_bbox(pdf_path, blocks) <span class="comment"># Display the image with bounding boxes around Blocks</span></span><br><span class="line"><span class="comment">#print_blocks(blocks) # Print information about Blocks</span></span><br></pre></td></tr></table></figure>
<p>The result is shown in the image below:<br>
<img src="/en/img/loading-icon.gif" data-original="https://i.imgur.com/szs2EFK.png" alt=""></p>
<h1 id="Advance-Clean-Code-Single-Page">Advance: Clean Code + Single Page</h1>
<p>This section is a bit more advanced, as we will clean up the code and make it suitable for single-page documents. To manage the code better, I have split the services into modules. Below is the file structure:</p>
<details class="toggle" ><summary class="toggle-button" style="">File Structure</summary><div class="toggle-content"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">‚îú‚îÄ‚îÄ resource</span><br><span class="line">‚îÇ¬†¬† ‚îú‚îÄ‚îÄ pdf <span class="comment"># put pdf file </span></span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ single-column.pdf</span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ multi-column.pdf</span><br><span class="line">‚îÇ¬†¬† ‚îî‚îÄ‚îÄ result <span class="comment"># put textract json file</span></span><br><span class="line">‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ single-column</span><br><span class="line">‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ final-result.json</span><br><span class="line">‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ multi-column</span><br><span class="line">‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ final-result.json</span><br><span class="line">‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ result_0.json</span><br><span class="line">‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ result_1.json</span><br><span class="line">‚îú‚îÄ‚îÄ src <span class="comment"># main source code </span></span><br><span class="line">‚îÇ¬†¬† ‚îú‚îÄ‚îÄ models <span class="comment"># Class</span></span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py</span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ block.py</span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ line.py</span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ page.py</span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ process_type.py</span><br><span class="line">‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ocr <span class="comment"># OCR related service </span></span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ util</span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py</span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ bbox_merger.py</span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ functions.py</span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ __init__.py</span><br><span class="line">‚îÇ¬†¬† ‚îî‚îÄ‚îÄ __init__.py</span><br><span class="line">‚îú‚îÄ‚îÄ tests</span><br><span class="line">‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py</span><br><span class="line">‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test_block_merge.ipynb</span><br><span class="line">‚îî‚îÄ‚îÄ README.md</span><br></pre></td></tr></table></figure></div></details>
<details class="toggle" ><summary class="toggle-button" style="">Entity Class file</summary><div class="toggle-content"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">‚îÇ¬†¬† ‚îú‚îÄ‚îÄ models</span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __pycache__</span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py</span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ block.py</span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ line.py</span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ page.py</span><br><span class="line">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ process_type.py</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"><span class="keyword">from</span> src.models.line <span class="keyword">import</span> Line</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Block</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.lines: <span class="type">List</span>[Line] = []</span><br><span class="line">        self.page: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">        self.reason: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.<span class="built_in">id</span>: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        self.left: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">        self.top: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">        self.height: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">        self.width: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Block: page=<span class="subst">&#123;self.page&#125;</span>, id=<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, (x1,y1)=(<span class="subst">&#123;self.left&#125;</span>, <span class="subst">&#123;self.top&#125;</span>), (x2,y2)=(<span class="subst">&#123;self.left + self.width&#125;</span>,<span class="subst">&#123;self.top + self.height&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_line</span>(<span class="params">self, line</span>):</span><br><span class="line">        self.lines.append(line)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Line</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, id_: <span class="built_in">str</span>, page: <span class="built_in">int</span>, text: <span class="built_in">str</span>, top: <span class="built_in">int</span>, left: <span class="built_in">int</span>, width: <span class="built_in">int</span>, height: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.top: <span class="built_in">int</span> = top</span><br><span class="line">        self.left: <span class="built_in">int</span> = left</span><br><span class="line">        self.width: <span class="built_in">int</span> = width</span><br><span class="line">        self.height: <span class="built_in">int</span> = height</span><br><span class="line"></span><br><span class="line">        self.page: <span class="built_in">int</span> = page</span><br><span class="line">        self.id_: <span class="built_in">str</span> = id_</span><br><span class="line">        self.text: <span class="built_in">str</span> = text</span><br><span class="line">        self.center: <span class="built_in">list</span> = self.get_center()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">f&quot;Line: \t page=<span class="subst">&#123;self.page&#125;</span>, &quot;</span></span><br><span class="line">                <span class="string">f&quot;Id=<span class="subst">&#123;self.id_&#125;</span>, &quot;</span></span><br><span class="line">                <span class="string">f&quot;Text=<span class="subst">&#123;self.text&#125;</span>, \n&quot;</span></span><br><span class="line">                <span class="string">f&quot;left=<span class="subst">&#123;self.left&#125;</span>, top=<span class="subst">&#123;self.top&#125;</span>); &quot;</span></span><br><span class="line">                <span class="string">f&quot;width=<span class="subst">&#123;self.width&#125;</span>, height=<span class="subst">&#123;self.height&#125;</span> \n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_center</span>(<span class="params">self</span>) -&gt; <span class="built_in">list</span>:</span><br><span class="line">        x = self.left</span><br><span class="line">        y = self.top</span><br><span class="line">        x1 = self.left + self.width</span><br><span class="line">        y1 = self.top + self.height</span><br><span class="line">        x_center = (x + x1) / <span class="number">2</span></span><br><span class="line">        y_center = (y + y1) / <span class="number">2</span></span><br><span class="line">        <span class="keyword">return</span> [x_center, y_center]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Page</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, page_number, lines</span>):</span><br><span class="line">        self.lines = lines</span><br><span class="line">        self.page = page_number</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> self.lines:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;line: <span class="subst">&#123;line.__str__()&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Page: <span class="subst">&#123;self.page&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProcessType</span>:</span><br><span class="line">    LINE = <span class="string">&quot;LINE&quot;</span></span><br><span class="line">    WORD = <span class="string">&quot;WORD&quot;</span></span><br></pre></td></tr></table></figure></div></details>
<details class="toggle" ><summary class="toggle-button" style="">General Function</summary><div class="toggle-content"><p><strong>src/ocr/util/functions.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># response</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> pdf2image <span class="keyword">import</span> convert_from_bytes</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_json_file</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        <span class="keyword">return</span> json.load(file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_file_to_bytes</span>(<span class="params">file_path: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[Image.Image]:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        pdf_binary = file.read()</span><br><span class="line">    <span class="keyword">return</span> convert_from_bytes(pdf_binary)</span><br></pre></td></tr></table></figure></div></details>
<details class="toggle" ><summary class="toggle-button" style="">bbox_merger.py: Turn lines to blocks class.</summary><div class="toggle-content"><p><strong>src/ocr/util/bbox_merger.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pdf2image <span class="keyword">import</span> convert_from_bytes</span><br><span class="line"><span class="keyword">from</span> matplotlib.patches <span class="keyword">import</span> Rectangle</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> src.models.block <span class="keyword">import</span> Block</span><br><span class="line"><span class="keyword">from</span> src.models.line <span class="keyword">import</span> Line</span><br><span class="line"><span class="keyword">from</span> src.ocr.util.functions <span class="keyword">import</span> read_json_file</span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ColumnType</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Column type, based on the column type of pdf.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    SINGLE = <span class="string">&quot;SINGLE&quot;</span></span><br><span class="line">    MULTI = <span class="string">&quot;MULTI&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_lines_from_json</span>(<span class="params">file_path: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[Line]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Get all type &quot;LINE&quot; from json file generated by textract.</span></span><br><span class="line"><span class="string">    :param file_path: json file generated by textract.</span></span><br><span class="line"><span class="string">    :return: list of Line.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    lines: <span class="type">List</span>[Line] = []</span><br><span class="line">    json_res = read_json_file(file_path)</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> json_res[<span class="string">&quot;Blocks&quot;</span>]:</span><br><span class="line">        <span class="keyword">if</span> item[<span class="string">&quot;BlockType&quot;</span>] == <span class="string">&quot;LINE&quot;</span>:</span><br><span class="line">            box = item[<span class="string">&quot;Geometry&quot;</span>][<span class="string">&quot;BoundingBox&quot;</span>]</span><br><span class="line">            lines.append(</span><br><span class="line">                Line(</span><br><span class="line">                    item[<span class="string">&quot;Id&quot;</span>],</span><br><span class="line">                    item[<span class="string">&quot;Page&quot;</span>],</span><br><span class="line">                    item[<span class="string">&quot;Text&quot;</span>],</span><br><span class="line">                    box[<span class="string">&quot;Top&quot;</span>],</span><br><span class="line">                    box[<span class="string">&quot;Left&quot;</span>],</span><br><span class="line">                    box[<span class="string">&quot;Width&quot;</span>],</span><br><span class="line">                    box[<span class="string">&quot;Height&quot;</span>]))</span><br><span class="line">    <span class="keyword">return</span> lines</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_blocks</span>(<span class="params">blocks: <span class="type">List</span>[Block]</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    print block and line information</span></span><br><span class="line"><span class="string">    :param blocks: blocks to print</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> block <span class="keyword">in</span> blocks:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;block.__str__()&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> block.lines:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;line.__str__()&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LineSimilarityChecker</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This class is used to check the similarity between two lines.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, column_type: ColumnType,</span></span><br><span class="line"><span class="params">                 distance_tolerance: <span class="built_in">float</span> = <span class="number">0.03</span>,</span></span><br><span class="line"><span class="params">                 width_tolerance: <span class="built_in">float</span> = <span class="number">0.01</span>,</span></span><br><span class="line"><span class="params">                 left_tolerance: <span class="built_in">float</span> = <span class="number">0.02</span>,</span></span><br><span class="line"><span class="params">                 height_tolerance: <span class="built_in">float</span> = <span class="number">0.02</span>,</span></span><br><span class="line"><span class="params">                 same_line_tolerance: <span class="built_in">float</span> = <span class="number">0.005</span></span></span><br><span class="line"><span class="params">                 </span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.column_type = column_type</span><br><span class="line"></span><br><span class="line">        self.distance_tolerance = distance_tolerance</span><br><span class="line">        self.width_tolerance = width_tolerance</span><br><span class="line">        self.left_tolerance = left_tolerance</span><br><span class="line">        self.height_tolerance = height_tolerance</span><br><span class="line">        self.same_line_tolerance = same_line_tolerance</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_left_similar</span>(<span class="params">self, line1, line2, tolerance=<span class="literal">None</span></span>):</span><br><span class="line">        tolerance = tolerance <span class="keyword">or</span> self.left_tolerance</span><br><span class="line">        <span class="keyword">return</span> self.pretty_similar(line1.left, line2.left, tolerance)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_width_similar</span>(<span class="params">self, line1, line2, tolerance=<span class="literal">None</span></span>):</span><br><span class="line">        tolerance = tolerance <span class="keyword">or</span> self.width_tolerance</span><br><span class="line">        <span class="keyword">return</span> self.pretty_similar(line1.width, line2.width, tolerance)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_height_similar</span>(<span class="params">self, line1, line2, tolerance=<span class="literal">None</span></span>):</span><br><span class="line">        tolerance = tolerance <span class="keyword">or</span> self.height_tolerance</span><br><span class="line">        <span class="keyword">return</span> self.two_point_height(line1.top, line2.top) &lt; tolerance</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_center_close</span>(<span class="params">self, line1: Line, line2: Line</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">return</span> self.two_point_distance(</span><br><span class="line">            line1.center[<span class="number">0</span>],</span><br><span class="line">            line1.center[<span class="number">1</span>],</span><br><span class="line">            line2.center[<span class="number">0</span>],</span><br><span class="line">            line2.center[<span class="number">1</span>]) &lt; self.distance_tolerance</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pretty_similar</span>(<span class="params">x: <span class="built_in">float</span>, x1: <span class="built_in">float</span>, tolerance: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">abs</span>(x - x1) &lt; tolerance</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">two_point_distance</span>(<span class="params">x: <span class="built_in">float</span>, y: <span class="built_in">float</span>, x1: <span class="built_in">float</span>, y1: <span class="built_in">float</span></span>):</span><br><span class="line">        distance = math.sqrt((x - x1) ** <span class="number">2</span> + (y - y1) ** <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> distance</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">two_point_height</span>(<span class="params">y: <span class="built_in">float</span>, y1: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">abs</span>(y - y1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LineMerger</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This class is used to turn lines to blocks by compare each line&#x27;s similarity.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, lines, column_type: ColumnType = ColumnType.SINGLE</span>):</span><br><span class="line">        self.column_type = column_type</span><br><span class="line">        self.line_check = LineSimilarityChecker(self.column_type)</span><br><span class="line">        self.lines: <span class="type">List</span>[Line] = lines</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_blocks</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[Block]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Get all blocks after turning lines into blocks.</span></span><br><span class="line"><span class="string">        :param column_type: column is SINGLE or MULTI default is SINGLE</span></span><br><span class="line"><span class="string">        :return: blocks</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        blocks = self.merge_lines_to_block(self.lines)</span><br><span class="line">        <span class="keyword">return</span> self.find_block_corners(blocks)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">merge_lines_to_block</span>(<span class="params">self, lines</span>) -&gt; <span class="type">List</span>[Block]:</span><br><span class="line">        blocks: <span class="type">List</span>[Block] = []</span><br><span class="line">        <span class="keyword">while</span> lines:</span><br><span class="line">            block = Block()</span><br><span class="line">            block.add_line(lines.pop(<span class="number">0</span>))</span><br><span class="line">            block.page = block.lines[<span class="number">0</span>].page</span><br><span class="line">            target_line = block.lines[<span class="number">0</span>]</span><br><span class="line">            index = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> index &lt; <span class="built_in">len</span>(lines):</span><br><span class="line">                cur_line = lines[index]</span><br><span class="line">                <span class="keyword">if</span> target_line.page == cur_line.page:</span><br><span class="line">                    <span class="comment"># for single column, when encounter number point, make a</span></span><br><span class="line">                    <span class="comment"># new a block</span></span><br><span class="line">                    <span class="keyword">if</span> self.column_type == ColumnType.SINGLE <span class="keyword">and</span> self.is_start_special_word(</span><br><span class="line">                            cur_line):</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;---Found special word---&quot;</span>)</span><br><span class="line">                        <span class="built_in">print</span>(cur_line.text)</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;---End special word: Jump to next block---&quot;</span>)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="comment"># other case, all need to compare the lines are close or</span></span><br><span class="line">                    <span class="comment"># not.</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">if</span> self.is_two_line_close(block, cur_line):</span><br><span class="line">                            block.add_line(cur_line)</span><br><span class="line">                            lines.pop(index)</span><br><span class="line">                            index = <span class="number">0</span></span><br><span class="line">                            <span class="keyword">continue</span></span><br><span class="line">                index += <span class="number">1</span></span><br><span class="line">            blocks.append(block)</span><br><span class="line">        <span class="keyword">return</span> blocks</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_start_special_word</span>(<span class="params">self, cur_line: Line</span>):</span><br><span class="line">        <span class="comment"># ÂÖàÂéªÂ≠ó‰∏≤ÂâçÂæåÁ©∫ÁôΩ Ê†πÊìöÁ©∫ÁôΩÈÄ≤Ë°åsplitÔºåÂèñÁ¨¨‰∏ÄÂÄãÂ≠ó‰∏≤</span></span><br><span class="line">        curStart = cur_line.text.strip().split(<span class="string">&quot; &quot;</span>)[<span class="number">0</span>]</span><br><span class="line">        pattern = self._regex_pattern()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> re.<span class="keyword">match</span>(pattern, curStart):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_regex_pattern</span>() -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="comment"># general word or number + &quot;.&quot;  + any words (e.g. 1.Hello my friend)</span></span><br><span class="line">        GENERAL_WORD_DOT_PATTERN = <span class="string">r&#x27;^[a-zA-Z0-9]\..*&#x27;</span></span><br><span class="line">        <span class="comment"># non-general one word or number + general one word or num + any word (e.g (1) This is ...)</span></span><br><span class="line">        NON_ALPHANUMERIC_WORD_PATTERN = <span class="string">r&#x27;[^a-zA-Z0-9][a-zA-Z0-9][^a-zA-Z0-9].*&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#123;&#125;|&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">            GENERAL_WORD_DOT_PATTERN,</span><br><span class="line">            NON_ALPHANUMERIC_WORD_PATTERN)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_two_line_close</span>(<span class="params">self, block, cur_line</span>):</span><br><span class="line">        last_line: Line = block.lines[-<span class="number">1</span>]</span><br><span class="line">        target_line: Line = block.lines[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.is_on_same_page(target_line, cur_line):</span><br><span class="line">            <span class="comment"># multi column: center text &amp; paragraph block</span></span><br><span class="line">            <span class="keyword">if</span> self.column_type == ColumnType.MULTI:</span><br><span class="line">                <span class="keyword">if</span> (self.is_same_paragraph(last_line, cur_line) <span class="keyword">or</span></span><br><span class="line">                        self.is_text_center_context(last_line, cur_line)):</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># single column: same line</span></span><br><span class="line">            <span class="keyword">elif</span> self.column_type == ColumnType.SINGLE:</span><br><span class="line">                <span class="keyword">if</span> (self.is_on_same_line(last_line, cur_line) <span class="keyword">or</span></span><br><span class="line">                        self.is_same_paragraph(last_line, cur_line)):</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_on_same_page</span>(<span class="params">line1, line2</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">return</span> line1.page == line2.page</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_on_same_line</span>(<span class="params">self, last_line, cur_line</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">return</span> self.line_check.is_height_similar(last_line, cur_line)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_same_paragraph</span>(<span class="params"></span></span><br><span class="line"><span class="params">            self,</span></span><br><span class="line"><span class="params">            last_line: Line,</span></span><br><span class="line"><span class="params">            cur_line: Line</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">if</span> (self.line_check.is_left_similar(last_line, cur_line)</span><br><span class="line">                <span class="keyword">and</span> self.line_check.is_height_similar(last_line, cur_line)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_text_center_context</span>(<span class="params">self, last_line: Line, cur_line: Line</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">return</span> (self.line_check.is_center_close(last_line, cur_line) <span class="keyword">and</span></span><br><span class="line">                self.line_check.is_height_similar(last_line, cur_line))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_block_corners</span>(<span class="params">blocks: <span class="type">List</span>[Block]</span>) -&gt; <span class="type">List</span>[Block]:</span><br><span class="line">        <span class="keyword">for</span> index, block <span class="keyword">in</span> <span class="built_in">enumerate</span>(blocks):</span><br><span class="line">            min_top = <span class="built_in">min</span>(line.top <span class="keyword">for</span> line <span class="keyword">in</span> block.lines)</span><br><span class="line">            min_left = <span class="built_in">min</span>(line.left <span class="keyword">for</span> line <span class="keyword">in</span> block.lines)</span><br><span class="line">            max_bottom = <span class="built_in">max</span>(line.top + line.height <span class="keyword">for</span> line <span class="keyword">in</span> block.lines)</span><br><span class="line">            max_right = <span class="built_in">max</span>(line.left + line.width <span class="keyword">for</span> line <span class="keyword">in</span> block.lines)</span><br><span class="line"></span><br><span class="line">            block.height = max_bottom - min_top</span><br><span class="line">            block.width = max_right - min_left</span><br><span class="line">            block.top = min_top</span><br><span class="line">            block.left = min_left</span><br><span class="line">            block.<span class="built_in">id</span> = index</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> blocks</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_image_bbox</span>(<span class="params">pdf_file, blocks</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    show image bounding box</span></span><br><span class="line"><span class="string">    :param pdf_file: the pdf file location</span></span><br><span class="line"><span class="string">    :param blocks: the list of blocks we want to draw</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(pdf_file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        images = convert_from_bytes(file.read())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> index, image <span class="keyword">in</span> <span class="built_in">enumerate</span>(images):</span><br><span class="line">        width, height = image.size</span><br><span class="line">        page = index + <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Process Page Index: <span class="subst">&#123;page&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        plt.figure(figsize=(<span class="number">20</span>, <span class="number">16</span>))</span><br><span class="line">        plt.imshow(image)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># iterate over the blocks</span></span><br><span class="line">        <span class="keyword">for</span> i, block <span class="keyword">in</span> <span class="built_in">enumerate</span>(blocks):</span><br><span class="line">            <span class="keyword">if</span> block.page == page:</span><br><span class="line">                rect = Rectangle(</span><br><span class="line">                    (width * block.left,</span><br><span class="line">                     height * block.top),</span><br><span class="line">                    block.width * width,</span><br><span class="line">                    block.height * height,</span><br><span class="line">                    edgecolor=<span class="string">&#x27;r&#x27;</span>,</span><br><span class="line">                    facecolor=<span class="string">&#x27;none&#x27;</span>)</span><br><span class="line">                plt.text(</span><br><span class="line">                    width * block.left,</span><br><span class="line">                    height * block.top,</span><br><span class="line">                    block.<span class="built_in">id</span>,</span><br><span class="line">                    fontsize=<span class="number">12</span>,</span><br><span class="line">                    color=<span class="string">&#x27;red&#x27;</span>)</span><br><span class="line">                plt.gca().add_patch(rect)</span><br><span class="line">        plt.show()</span><br></pre></td></tr></table></figure></div></details>
<p>Then we can call the method directly.<br>
<strong>tests/test_block_merge.ipynb</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> src.ocr.util.bbox_merger <span class="keyword">import</span> (</span><br><span class="line">    show_image_bbox, </span><br><span class="line">    get_lines_from_json, </span><br><span class="line">    LineMerger, </span><br><span class="line">    print_blocks, </span><br><span class="line">    ColumnType</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Value</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, is_multi_column: <span class="built_in">bool</span></span>):</span><br><span class="line">        <span class="keyword">if</span> is_multi_column:</span><br><span class="line">            self.topic = <span class="string">&quot;multi-column&quot;</span></span><br><span class="line">            self.column_type = ColumnType.MULTI</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.topic = <span class="string">&quot;single-column&quot;</span></span><br><span class="line">            self.column_type = ColumnType.SINGLE</span><br><span class="line">            </span><br><span class="line">        self.json_path = <span class="string">&#x27;../resource/result/&#123;&#125;/final-result.json&#x27;</span>.<span class="built_in">format</span>(self.topic)</span><br><span class="line">        self.pdf_path = <span class="string">&#x27;../resource/pdf/&#123;&#125;.pdf&#x27;</span>.<span class="built_in">format</span>(self.topic)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">is_multi_column: <span class="built_in">bool</span></span>):</span><br><span class="line">    v = Value(is_multi_column = is_multi_column)</span><br><span class="line">    lines = get_lines_from_json(v.json_path)</span><br><span class="line">    blocks = LineMerger(lines, v.column_type).get_blocks()</span><br><span class="line">    print_blocks(blocks)</span><br><span class="line">    show_image_bbox(pdf_file=v.pdf_path, blocks=blocks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main(is_multi_column = <span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://shannonhung.github.io/en">Shannon Hung</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://shannonhung.github.io/en/posts/textract-multi-column/">https://shannonhung.github.io/en/posts/textract-multi-column/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/en/tags/aws/">aws</a><a class="post-meta__tags" href="/en/tags/textract/">textract</a></div><div class="post_share"><div class="social-share" data-image="/en/img/cover/ocr-scan.jpeg" data-sites="facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/en/posts/nlp-twitter-emotion-diagnoise/" title="Twitter Dataset - Using LSTM to predict the emotion of the article"><img class="cover" src="/en/img/loading-icon.gif" data-original="/en/img/cover/lstm-emotion.jpeg" onerror="onerror=null;src='/en/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">Twitter Dataset - Using LSTM to predict the emotion of the article</div></div></a></div><div class="next-post pull-right"><a href="/en/posts/TensorFlow-Windows-GPU-Setup/" title="Windows - A Step-by-Step Guide to Enable CUDA GPU on TensorFlow"><img class="cover" src="/en/img/loading-icon.gif" data-original="/en/img/cover/mac_ai_gpu.jpeg" onerror="onerror=null;src='/en/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">Windows - A Step-by-Step Guide to Enable CUDA GPU on TensorFlow</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/en/img/loading-icon.gif" data-original="/en/img/dudu-me.png" onerror="this.onerror=null;this.src='/en/en/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Shannon Hung</div><div class="author-info__description">In order to avoid forgetfulness, I started to record</div></div><div class="card-info-data site-data is-center"><a href="/en/archives/"><div class="headline">Articles</div><div class="length-num">13</div></a><a href="/en/tags/"><div class="headline">Tags</div><div class="length-num">12</div></a><a href="/en/categories/"><div class="headline">Categories</div><div class="length-num">12</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/ShannonHung"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ShannonHung" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:hsuanhung036@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #24292e;"></i></a><a class="social-icon" href="https://www.linkedin.com/in/hung-yi-hsuan/" rel="external nofollow noreferrer" target="_blank" title="LinkedIn"><i class="fas fa-linkedin" style="color: #0077b5;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">I am a graduate student at the Taiwan University of Science and Technology - Institute of Information Management, planning to pursue a dual-degree program in Germany this year. The reason behind setting up this website is my rather short memory span. While I have learned a lot, I tend to forget much of it. To combat forgetfulness, I have embarked on my note-taking journey.</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">ÂâçË®Ä</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Textract-Response-Format"><span class="toc-text">Textract Response Format</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Solution"><span class="toc-text">Solution</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1-Define-the-Class"><span class="toc-text">Step 1: Define the Class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-2-General-Function"><span class="toc-text">Step 2: General Function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3-Define-Rule-of-Block"><span class="toc-text">Step 3: Define Rule of Block</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-4-Iterate-Line-to-Form-Block"><span class="toc-text">Step 4: Iterate Line to Form Block</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-5-Execution"><span class="toc-text">Step 5: Execution</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Advance-Clean-Code-Single-Page"><span class="toc-text">Advance: Clean Code + Single Page</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/en/posts/TensorFlow-Windows-GPU-Setup/" title="Windows - A Step-by-Step Guide to Enable CUDA GPU on TensorFlow"><img src="/en/img/loading-icon.gif" data-original="/en/img/cover/mac_ai_gpu.jpeg" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Windows - A Step-by-Step Guide to Enable CUDA GPU on TensorFlow"/></a><div class="content"><a class="title" href="/en/posts/TensorFlow-Windows-GPU-Setup/" title="Windows - A Step-by-Step Guide to Enable CUDA GPU on TensorFlow">Windows - A Step-by-Step Guide to Enable CUDA GPU on TensorFlow</a><time datetime="2024-09-04T12:55:39.000Z" title="Created 2024-09-04 20:55:39">2024-09-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/posts/textract-multi-column/" title="How to Handle Multi-Column Text Sorting with Amazon Textract"><img src="/en/img/loading-icon.gif" data-original="/en/img/cover/ocr-scan.jpeg" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="How to Handle Multi-Column Text Sorting with Amazon Textract"/></a><div class="content"><a class="title" href="/en/posts/textract-multi-column/" title="How to Handle Multi-Column Text Sorting with Amazon Textract">How to Handle Multi-Column Text Sorting with Amazon Textract</a><time datetime="2024-03-19T16:40:35.000Z" title="Created 2024-03-20 00:40:35">2024-03-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/posts/nlp-twitter-emotion-diagnoise/" title="Twitter Dataset - Using LSTM to predict the emotion of the article"><img src="/en/img/loading-icon.gif" data-original="/en/img/cover/lstm-emotion.jpeg" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Twitter Dataset - Using LSTM to predict the emotion of the article"/></a><div class="content"><a class="title" href="/en/posts/nlp-twitter-emotion-diagnoise/" title="Twitter Dataset - Using LSTM to predict the emotion of the article">Twitter Dataset - Using LSTM to predict the emotion of the article</a><time datetime="2023-11-16T06:30:45.000Z" title="Created 2023-11-16 14:30:45">2023-11-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/posts/coco-object-diagnoise/" title="COCO Dataset - use Faster RCNN + MobileNet to conduct Object Detection"><img src="/en/img/loading-icon.gif" data-original="/en/img/cover/object-detection.jpeg" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="COCO Dataset - use Faster RCNN + MobileNet to conduct Object Detection"/></a><div class="content"><a class="title" href="/en/posts/coco-object-diagnoise/" title="COCO Dataset - use Faster RCNN + MobileNet to conduct Object Detection">COCO Dataset - use Faster RCNN + MobileNet to conduct Object Detection</a><time datetime="2023-11-03T02:57:54.000Z" title="Created 2023-11-03 10:57:54">2023-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/posts/flower102-transfer-learning/" title="Flower102 Dataset - Using Transfer Learning to train + Using Batch Normalization in CNN"><img src="/en/img/loading-icon.gif" data-original="/en/img/cover/flower-ml.jpeg" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Flower102 Dataset - Using Transfer Learning to train + Using Batch Normalization in CNN"/></a><div class="content"><a class="title" href="/en/posts/flower102-transfer-learning/" title="Flower102 Dataset - Using Transfer Learning to train + Using Batch Normalization in CNN">Flower102 Dataset - Using Transfer Learning to train + Using Batch Normalization in CNN</a><time datetime="2023-10-31T06:27:13.000Z" title="Created 2023-10-31 14:27:13">2023-10-31</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Shannon Hung</div><div class="footer_custom_text">Hi, welcome to Shannon <a target="_blank" rel="noopener external nofollow noreferrer" href="https://butterfly.js.org/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional Chinese And Simplified Chinese">EN</button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/en/js/utils.js"></script><script src="/en/js/main.js"></script><script src="/en/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: '51917ecdc184bb98b226',
      clientSecret: 'e48b44c1908c14b74ff7513f06c7cb892a4f4748',
      repo: 'shannonhung.github.io',
      owner: 'ShannonHung',
      admin: ['ShannonHung'],
      id: '1ae47b5c43793d8f1fbfacc8fe58e425',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script data-pjax src="/en/self/btf.js"></script><script data-pjax src="/en/self/tw_en.js"></script><script id="canvas_nest" defer="defer" color="139,71,38" opacity="0.5" zIndex="-1" count="500" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/en/js/search/local-search.js"></script></div></div>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 3,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body></html>